# React Fiber

## Краткий ответ для собеседования

**React Fiber** — новая архитектура reconciler в React 16+. Разбивает рендеринг на маленькие единицы работы (fiber-узлы), позволяет прерывать, возобновлять и приоритизировать обновления. Состоит из двух фаз: **Render** (прерываемая, вычисляет изменения) и **Commit** (непрерываемая, применяет изменения к DOM). Fiber-дерево — это связанный список узлов с информацией о компонентах. Появился для реализации **Concurrent Mode** — рендеринг с приоритетами для плавного UI.

---

## Что такое React Fiber

**React Fiber** — это **новая имплементация ядра React** (reconciler), которая была представлена в React 16 (2017).

**Основная цель:**  
Сделать рендеринг **прерываемым** и **приоритизируемым** — React может прерывать работу, чтобы обработать более важные задачи (например, пользовательский ввод), а потом вернуться к прежней работе.

**Что изменилось:**
- **Старый алгоритм (Stack Reconciler)** — синхронный, блокирующий, рекурсивный
- **Fiber** — асинхронный, прерываемый, итеративный (через связанный список)

---

## Почему появился Fiber

### Проблемы старого Stack Reconciler

1. **Блокировка UI** — рендеринг был синхронным, нельзя было прервать
2. **Долгие обновления** — большое дерево компонентов могло "заморозить" UI
3. **Нет приоритетов** — все обновления обрабатывались одинаково
4. **60 FPS** — если рендеринг занимал > 16ms (1/60 секунды), анимации "лагали"

**Пример:**  
Печатаешь в input → React рендерит большой список → ввод "тормозит" (UI заблокирован).

### Решение: Fiber

- **Прерываемый рендеринг** — можно остановиться, обработать ввод, продолжить
- **Приоритеты** — важные обновления (ввод) выполняются раньше неважных (фоновая загрузка)
- **Плавный UI** — никаких "заморозок"

---

## Что такое Fiber (узел)

**Fiber** — это **объект JavaScript**, который представляет **единицу работы** (компонент, DOM-элемент).

**Структура fiber-узла (упрощённо):**

```js
{
  type: 'div',              // тип элемента (div, span, функция-компонент)
  props: { ... },           // props компонента
  stateNode: DOMElement,    // ссылка на реальный DOM-узел
  child: Fiber,             // первый дочерний fiber
  sibling: Fiber,           // следующий sibling fiber
  return: Fiber,            // родительский fiber
  alternate: Fiber,         // fiber из предыдущего дерева (для сравнения)
  effectTag: 'PLACEMENT',   // тип изменения (создать, обновить, удалить)
}
```

**Важно:**  
Fiber-узлы связаны через **child**, **sibling**, **return** → образуют **связанный список** (а не дерево в классическом понимании).

---

## Fiber-дерево

React создаёт **два fiber-дерева**:

### 1. Current Fiber Tree

**Отображается на экране** — текущее состояние UI.

### 2. Work-in-Progress (WIP) Fiber Tree

**Новое дерево**, которое React строит во время обновления.

**Процесс:**
1. React получает обновление (`setState`, новые props)
2. Создаёт WIP-дерево (клонирует + применяет изменения)
3. Когда WIP готов → **меняет указатель**: WIP становится Current

**Это называется "двойная буферизация" (double buffering).**

---

## Две фазы работы Fiber

### 1. Render Phase (Фаза рендеринга)

**Что происходит:**
- React проходит по fiber-дереву
- Вызывает функции-компоненты / lifecycle-методы
- Вычисляет, что изменилось (reconciliation)
- Строит список изменений (effects)

**Особенности:**
- **Прерываемая** — можно остановить, возобновить, выбросить
- **Без побочных эффектов** — никакого DOM, никаких сетевых запросов
- **Может вызываться несколько раз** — если React прерывает и возобновляет

**Что вызывается:**
- `render()` в классах
- Функциональный компонент
- `getDerivedStateFromProps`
- `shouldComponentUpdate`

---

### 2. Commit Phase (Фаза коммита)

**Что происходит:**
- React применяет изменения к **реальному DOM**
- Вызывает lifecycle-методы и хуки с побочными эффектами
- Обновляет refs

**Особенности:**
- **Непрерываемая** — выполняется синхронно, за один проход
- **С побочными эффектами** — мутации DOM, `useEffect`, `componentDidMount`
- **Выполняется один раз** — после завершения Render Phase

**Что вызывается:**
- `componentDidMount`, `componentDidUpdate`, `componentWillUnmount`
- `useLayoutEffect` (синхронно)
- `useEffect` (асинхронно, после отрисовки)

---

## Как Fiber работает (пошагово)

### 1. Обновление инициируется

```jsx
setState({ count: 1 });
```

### 2. Render Phase начинается

- React создаёт Work-in-Progress (WIP) дерево
- Проходит по fiber-узлам:
  - Начинает с корня
  - Переходит к `child` → `sibling` → `return` (обход в глубину)
- Для каждого узла:
  - Вызывает функцию-компонент или `render()`
  - Сравнивает новый результат со старым
  - Помечает изменения (`effectTag`: PLACEMENT, UPDATE, DELETION)

**Важно:**  
React может **прервать** эту фазу (например, если пришёл клик пользователя с высоким приоритетом).

### 3. Commit Phase начинается

- React проходит по списку изменений (effects)
- Применяет изменения к DOM:
  - **PLACEMENT** — вставить элемент
  - **UPDATE** — обновить атрибуты
  - **DELETION** — удалить элемент
- Вызывает lifecycle-методы и хуки

### 4. Завершение

- WIP-дерево становится Current
- Пользователь видит обновлённый UI

---

## Приоритеты обновлений

Fiber позволяет React **различать приоритеты** обновлений:

| Приоритет | Примеры | Обработка |
|-----------|---------|-----------|
| **Синхронный (Sync)** | `ReactDOM.render`, события клика | Немедленно |
| **Высокий (User Blocking)** | Ввод в input, hover | Быстро (~250ms) |
| **Обычный (Normal)** | Сетевые запросы, `setState` | Обычная очередь |
| **Низкий (Low)** | Аналитика, логи | Можно отложить |
| **Idle** | Фоновая работа | Когда браузер свободен |

**Пример:**
- Печатаешь в input (высокий приоритет) → React прерывает рендеринг большого списка (низкий приоритет)
- Обрабатывает ввод → возвращается к списку

---

## Concurrent Mode (Конкурентный режим)

**Concurrent Mode** — режим, в котором React может работать над **несколькими обновлениями одновременно**.

**Возможности:**
- **Приоритизация** — важные обновления вытесняют неважные
- **Прерываемый рендеринг** — React может остановиться и вернуться
- **Time Slicing** — разбивает работу на маленькие кусочки, выполняет между кадрами
- **Suspense** — показ fallback UI, пока данные загружаются

**Как Fiber влияет на Concurrent Mode:**

Fiber **делает Concurrent Mode возможным**:
- Без Fiber (старый Stack Reconciler) рендеринг был синхронным и непрерываемым
- С Fiber React может прерывать, приоритизировать, возобновлять — это основа Concurrent Mode

---

## Что изменилось для разработчиков

### Что осталось прежним

- **API React не изменился** — `useState`, `useEffect`, классы работают так же
- **Компоненты пишутся так же** — никаких изменений в коде

### Что изменилось

1. **Lifecycle-методы Render Phase могут вызываться несколько раз**

Методы `render()`, `getDerivedStateFromProps`, `shouldComponentUpdate` должны быть **чистыми** (без побочных эффектов), потому что React может вызвать их несколько раз (прерывание и возобновление).

**Устаревшие методы удалены:**
- `componentWillMount`
- `componentWillReceiveProps`
- `componentWillUpdate`

Эти методы **не были чистыми** → проблемы в Concurrent Mode.

2. **Появились новые возможности**

- `Suspense` — ожидание данных/компонентов
- `useTransition` — низкоприоритетные обновления
- `useDeferredValue` — отложенные значения

---

## Вопросы на собеседовании

| Вопрос | Краткий ответ |
|--------|----------------|
| Что такое React Fiber? | Новая архитектура reconciler в React 16+, делает рендеринг прерываемым и приоритизируемым |
| Почему появился Fiber? | Старый алгоритм блокировал UI; нужна была возможность прерывать рендеринг и работать с приоритетами |
| Что такое fiber-узел? | Объект JavaScript, представляющий единицу работы (компонент, элемент); связаны в список |
| Что такое fiber-дерево? | Структура из fiber-узлов, связанных через child/sibling/return; React создаёт Current и WIP деревья |
| Какие две фазы работы Fiber? | **Render** (прерываемая, вычисляет изменения) и **Commit** (непрерываемая, применяет к DOM) |
| Какая фаза прерываемая? | Render — React может остановить, обработать важное событие, вернуться |
| Какая фаза непрерываемая? | Commit — изменения применяются к DOM синхронно, за один проход |
| Что такое Concurrent Mode? | Режим, где React работает над несколькими обновлениями с приоритетами; возможен благодаря Fiber |
| Как Fiber влияет на Concurrent Mode? | Fiber делает его возможным — прерываемый рендеринг и приоритеты |
| Что изменилось для разработчиков? | API то же, но Render Phase методы должны быть чистыми; устаревшие lifecycle удалены |

---

## Кратко для ответа

React Fiber — новая архитектура reconciler (React 16+), делающая рендеринг прерываемым и приоритизируемым. Fiber-узел — единица работы (объект с информацией о компоненте), связаны в список (fiber-дерево). Две фазы: **Render** (прерываемая, вычисляет изменения, может вызываться несколько раз) и **Commit** (непрерываемая, применяет к DOM). Fiber позволяет React приоритизировать обновления и реализовать **Concurrent Mode** — работу над несколькими обновлениями одновременно с разными приоритетами.
