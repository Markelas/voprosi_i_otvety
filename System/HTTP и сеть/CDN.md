# CDN (Content Delivery Network)

## Краткий ответ для собеседования

**CDN** — сеть географически распределённых серверов (edge-узлов), которые отдают статику (HTML, CSS, JS, изображения, шрифты) пользователю с ближайшего к нему узла. Цель: уменьшить задержку (latency), разгрузить origin-сервер и ускорить загрузку. Для фронтенда CDN — это то, откуда чаще всего раздаётся собранный билд и статика; разработчику важно понимать кэширование (Cache-Control, инвалидация), деплой на CDN и влияние на обновления версий (хеши в именах файлов, purge/invalidate).

---

## Что такое CDN

**CDN (Content Delivery Network)** — распределённая сеть серверов (популярно называемых **edge-узлами** или **edge-серверами**), расположенных в разных регионах и дата-центрах. Они хранят копии статического контента (или кэшируют ответы origin-сервера) и отдают его пользователю с того узла, который к нему ближе по сети.

**Origin (источник)** — ваш основной сервер или хранилище (S3, сервер приложения), откуда CDN впервые забирает контент и при необходимости обновляет кэш.

Простыми словами: вместо того чтобы все пользователи мира качали картинки и JS с одного сервера в одном месте, CDN держит копии рядом с пользователями — в Европе, Азии, Америке и т.д. Запрос обрабатывает ближайший узел → меньше задержка, быстрее загрузка.

![[Screenshot at Jan 31 18-38-57.png]]

---

## Как работает CDN

1. **Первый запрос к ресурсу** (например, `https://cdn.example.com/assets/main.abc123.js`):
   - Запрос попадает на ближайший edge-узел CDN.
   - Если у узла нет копии (cache miss), он запрашивает файл у **origin** (ваш сервер или S3), сохраняет в свой кэш и отдаёт пользователю.
2. **Последующие запросы** (к тому же URL с того же или соседнего региона):
   - Edge-узел отдаёт контент из своего кэша (cache hit) — запрос до origin не доходит.
3. **Срок жизни кэша** задаётся заголовками (Cache-Control, Expires) в ответе origin или настройками CDN. После истечения TTL узел может снова запросить контент у origin (revalidate).

**Итог:** основная нагрузка по раздаче статики снимается с origin; пользователи получают контент с малой задержкой.

---

## Связь CDN с фронтендом

- **Раздача статики приложения** — после сборки (Vite, Webpack, Next.js и т.д.) билд (JS, CSS, картинки, шрифты) заливается на origin (S3, сервер) и раздаётся через CDN. Браузер качает `main.[hash].js`, `style.[hash].css` и т.д. с CDN.
- **Ускорение загрузки** — меньше RTT (round-trip time) до сервера, часто лучшая пропускная способность до edge-узла.
- **Снижение нагрузки на backend** — HTML страницы могут отдаваться с origin (если они динамические), а статика — с CDN; бэкенд не отдаёт миллионы запросов за картинки и скрипты.
- **HTTPS и домен** — CDN обычно предоставляет свой домен (например, `cdn.example.com` или `xxx.cloudfront.net`) и берёт на себя терминацию SSL; фронтенд просто использует ссылки на этот домен в сборке или в конфиге.

Для фронтенд-разработчика приложение в продакшене в большинстве случаев «лежит» на CDN: деплой = загрузка файлов на origin, откуда их раздаёт CDN.

---

## Что CDN значит для разработчика

### 1. Кэширование и заголовки

CDN (и браузер) кэшируют ответы по правилам **Cache-Control** (и при необходимости ETag, Last-Modified). Что отдаёт origin или как настроен CDN — напрямую влияет на то, как быстро пользователи увидят обновления.

- **Долгое кэширование статики с хешем в имени**  
  Файлы вида `main.abc123.js` можно кэшировать надолго (`Cache-Control: public, max-age=31536000`), потому что при изменении кода имя файла меняется (новый хеш) → новый URL → новая загрузка. Старые версии спокойно живут в кэше.
- **Короткое кэш или no-cache для HTML**  
  HTML часто ссылается на эти хешированные файлы. Если HTML кэшировать надолго, пользователь может долго не получать новый HTML с новыми именами файлов и не видеть обновлений. Поэтому для `index.html` обычно ставят короткий max-age или no-cache.
- **s-maxage, CDN и браузер**  
  Директива **s-maxage** (и иногда **stale-while-revalidate**) влияет на кэш на стороне CDN; **max-age** — на браузер. Разработчику полезно знать, что кэш бывает «у CDN» и «у пользователя».

Итог: разработчик должен понимать, какие заголовки кэширования выставляет сборка/сервер для статики и для HTML, чтобы и скорость была высокой, и обновления доходили.

### 2. Инвалидация кэша (purge / invalidate)

Если файл обновился на origin, но URL не изменился (например, старый деплой без хешей в именах), старые копии могут продолжать отдаваться из кэша CDN и браузера. Чтобы пользователи получили новую версию:

- **Изменить URL** — версионирование или хеш в имени файла (рекомендуемый подход для статики).
- **Инвалидация кэша на CDN** — в панели CDN (CloudFront, Cloudflare, Fastly и т.д.) делают «purge» или «invalidate» по путям или по тегам. После этого edge-узлы при следующем запросе снова возьмут контент с origin.

Разработчику нужно знать: как в вашем проекте деплоится статика, есть ли хеши в именах файлов и когда/кто делает purge CDN при релизе.

### 3. Деплой и версионирование

- **Сборка** генерирует файлы с хешами (например, Vite/Webpack output с `[contenthash]`). HTML ссылается на эти имена. Деплой = загрузка новой папки/билда на origin (S3, сервер). CDN раздаёт то, что отдаёт origin.
- **Не перезатирать старые файлы до истечения кэша** — если старые версии ещё кэшируются, лучше не удалять их с origin сразу (или использовать версионированные пути), чтобы у пользователей со старым HTML не ломался запрос к `main.oldhash.js`.

То, что статика раздаётся через CDN, не меняет логику сборки, но накладывает требования к именованию файлов и к политике кэширования.

### 4. CORS и домены

Если фронт и статика на поддомене CDN (например, `cdn.example.com`), а API на `api.example.com` — это уже вопрос CORS и cookie (SameSite, домен). Для статики (JS, CSS, картинки) CORS часто не мешает загрузке самих файлов; для запросов из JS к другому домену CORS настраивается на API. Разработчику достаточно помнить, что «статика с CDN» — это другой домен/поддомен и при необходимости учитывать это в настройках запросов и cookie.

### 5. Мониторинг и отладка

- В DevTools во вкладке Network видно, с какого хоста пришёл ресурс (ваш origin или CDN-домен).
- Заголовки ответа (Cache-Control, Age, X-Cache: Hit/Miss и т.д.) показывают, отдано ли из кэша CDN и как долго ответ считается свежим. Это помогает проверять, что кэш ведёт себя так, как задумано.

---

## Что нужно знать разработчику (чек-лист)

| Тема | Зачем |
|------|--------|
| **Что такое CDN** | Сеть edge-серверов, раздача контента с ближайшего узла, разгрузка origin, меньше latency. |
| **Роль в фронтенде** | Статика приложения (JS, CSS, изображения) обычно раздаётся через CDN после деплоя на origin. |
| **Cache-Control** | Управляет кэшем у CDN и браузера; от него зависит скорость и актуальность контента. |
| **Версионирование файлов (хеш в имени)** | Долгий кэш для статики без риска «застрять» на старой версии; HTML — короткий кэш или no-cache. |
| **Инвалидация (purge)** | Когда URL не меняется, обновления доходят после purge кэша на CDN или смены URL. |
| **Деплой** | Понимать, куда попадает билд (origin), как CDN забирает оттуда контент и как обновляется версия у пользователя. |
| **CORS/домен** | Статика с CDN = отдельный домен; при запросах к API и cookie учитывать домены и CORS. |
| **Заголовки в ответах** | Уметь посмотреть Cache-Control, Age, X-Cache в DevTools и связать с поведением кэша. |

---

## Вопросы на собеседовании

| Вопрос | Краткий ответ |
|--------|----------------|
| Что такое CDN? | Сеть распределённых серверов (edge), отдающих контент с ближайшего к пользователю узла; меньше задержка, разгрузка origin. |
| Как CDN связан с фронтендом? | Собранная статика (JS, CSS, картинки) деплоится на origin и раздаётся через CDN; пользователи качают её с edge-узлов. |
| Зачем фронтенду хеш в имени файла (main.[hash].js)? | Чтобы кэшировать файл надолго; при изменении кода новое имя → новый URL → пользователь получает новую версию без ручного purge. |
| Почему для index.html часто не ставят долгий кэш? | HTML ссылается на актуальные имена файлов; если кэшировать HTML надолго, пользователь не получит обновлённые ссылки на новый билд. |
| Что такое purge/invalidate в CDN? | Принудительное удаление (инвалидация) кэша по путям или тегам, чтобы edge-узлы снова забрали контент с origin после обновления. |
| Что важно настроить разработчику при использовании CDN? | Заголовки кэширования (Cache-Control) для статики и HTML, версионирование файлов, понимание процесса деплоя и при необходимости purge. |

---

## Кратко для ответа

**CDN** — сеть edge-серверов, раздающих контент с ближайшего узла; уменьшает задержку и нагрузку на origin. Для фронтенда через CDN раздаётся статика приложения после деплоя. Разработчику нужно: правильно настроить кэширование (Cache-Control), использовать хеши в именах файлов для долгого кэша статики, не кэшировать HTML надолго, понимать деплой и при необходимости инвалидацию кэша CDN.
