# Загрузка ресурсов с разных доменов

## Краткий ответ для собеседования

Браузеры ограничивают количество **параллельных соединений на один домен** (6-8 в современных браузерах по HTTP/1.1). Загрузка с разных доменов (domain sharding) позволяет обойти это ограничение и загружать больше ресурсов параллельно → быстрее. В HTTP/2 это не нужно (мультиплексирование). Дополнительные преимущества: разделение статики и динамики, географическое распределение (CDN), снижение нагрузки на основной сервер.

---

## Проблема: ограничение параллельных соединений

### HTTP/1.1

Браузеры ограничивают количество **одновременных TCP-соединений** к одному домену:
- **HTTP/1.1:** обычно 6-8 соединений на домен

**Почему:**  
Историческое ограничение (RFC 2616 рекомендовал 2, браузеры увеличили до 6-8).

**Проблема:**  
Если на странице 50 ресурсов с одного домена (`example.com`), они загружаются **очередями по 6-8 штук** → медленно.

**Пример:**

```html
<img src="https://example.com/img1.jpg">
<img src="https://example.com/img2.jpg">
...
<img src="https://example.com/img50.jpg">
```

→ Браузер загрузит 6-8 изображений параллельно, остальные ждут в очереди.

---

## Решение: Domain Sharding (разделение доменов)

**Domain Sharding** — техника распределения ресурсов по **разным поддоменам или доменам**, чтобы обойти ограничение на количество соединений.

**Пример:**

```html
<img src="https://cdn1.example.com/img1.jpg">
<img src="https://cdn2.example.com/img2.jpg">
<img src="https://cdn3.example.com/img3.jpg">
<img src="https://cdn1.example.com/img4.jpg">
...
```

**Результат:**
- `cdn1.example.com` — 6 соединений
- `cdn2.example.com` — 6 соединений
- `cdn3.example.com` — 6 соединений
- **Итого: до 18 параллельных соединений**

---

## Преимущества загрузки с разных доменов

### 1. Больше параллельных соединений

Обход ограничения браузера → быстрее загрузка.

### 2. Географическое распределение (CDN)

Ресурсы размещаются на серверах **ближе к пользователю**:
- `cdn-us.example.com` — для США
- `cdn-eu.example.com` — для Европы
- `cdn-asia.example.com` — для Азии

→ Меньше latency, быстрее загрузка.

### 3. Разделение статики и динамики

- `example.com` — основной сайт (HTML, API)
- `static.example.com` — статические файлы (CSS, JS, изображения)

**Преимущества:**
- Статика кэшируется агрессивно (долгий TTL)
- Основной домен не перегружается
- Можно использовать cookieless-домен (без cookies → меньше трафика)

### 4. Снижение нагрузки на основной сервер

Статика отдаётся с CDN/отдельного сервера → основной сервер обрабатывает только динамику.

---

## Ограничения Domain Sharding

### 1. DNS-запросы

Каждый новый домен → **дополнительный DNS-запрос** (20-100ms).

**Решение:**  
Использовать `<link rel="dns-prefetch">`:

```html
<link rel="dns-prefetch" href="//cdn1.example.com">
<link rel="dns-prefetch" href="//cdn2.example.com">
```

### 2. Установка TCP-соединений

Каждый домен → новое TCP-соединение (3-way handshake) + TLS handshake (для HTTPS).

**Цена:** ~100-200ms на каждое соединение.

### 3. Не нужно для HTTP/2

В **HTTP/2** ограничение снято — **мультиплексирование** позволяет загружать множество ресурсов через **одно соединение**.

**Вывод:**  
Domain Sharding устарел для HTTP/2; более того, может **замедлить** из-за дополнительных DNS/TCP-соединений.

---

## Оптимальное количество доменов

**Рекомендация:** 2-4 домена.

**Почему:**
- Слишком мало (1) — не используем весь потенциал параллелизма
- Слишком много (10+) — много DNS/TCP-запросов, замедление

**Пример:**
- `example.com` — основной сайт
- `cdn1.example.com` — изображения
- `cdn2.example.com` — CSS/JS
- `cdn3.example.com` — видео, шрифты

---

## HTTP/2 и мультиплексирование

### Что изменилось

В **HTTP/2** один TCP-сокет может передавать **множество ресурсов параллельно** (мультиплексирование).

**Нет ограничения** на 6-8 соединений — все ресурсы загружаются через **одно соединение**.

### Domain Sharding в HTTP/2

**Не нужен и вреден:**
- Дополнительные DNS-запросы
- Дополнительные TCP/TLS-соединения
- Потеря преимуществ мультиплексирования (один connection pool)

**Рекомендация:**  
Использовать **один домен** для HTTP/2.

---

## Практические рекомендации

### Для HTTP/1.1

✅ Использовать Domain Sharding (2-4 домена)  
✅ Использовать DNS Prefetch  
✅ Разделять статику и динамику  
✅ CDN для географического распределения

### Для HTTP/2

✅ Один домен (domain sharding не нужен)  
✅ CDN для географического распределения  
✅ Server Push (опционально)

### Универсально

✅ Использовать CDN  
✅ Кэширование (долгий TTL для статики)  
✅ Сжатие (gzip, brotli)  
✅ Ленивая загрузка изображений  
✅ Code splitting

---

## Вопросы на собеседовании

| Вопрос | Краткий ответ |
|--------|----------------|
| Зачем загружать ресурсы с разных доменов? | Обход ограничения браузера на параллельные соединения (6-8 на домен в HTTP/1.1) |
| Что такое Domain Sharding? | Распределение ресурсов по разным поддоменам для увеличения параллелизма |
| Какое ограничение на соединения в HTTP/1.1? | 6-8 параллельных соединений на один домен |
| Нужен ли Domain Sharding для HTTP/2? | Нет, HTTP/2 использует мультиплексирование (множество ресурсов через одно соединение) |
| Какие недостатки Domain Sharding? | Дополнительные DNS-запросы, TCP/TLS-соединения; замедляет HTTP/2 |
| Сколько доменов оптимально? | 2-4 для HTTP/1.1; 1 для HTTP/2 |

---

## Кратко для ответа

Браузеры ограничивают параллельные соединения на домен (6-8 в HTTP/1.1). Domain Sharding — распределение ресурсов по разным доменам для обхода ограничения и ускорения загрузки. Преимущества: больше параллелизма, CDN (географическое распределение), разделение статики и динамики. В HTTP/2 не нужен (мультиплексирование), более того — вреден (лишние DNS/TCP-соединения).
