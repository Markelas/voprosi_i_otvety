# JavaScript движок

## Краткий ответ для собеседования

**JavaScript движок** — это программа, которая выполняет JavaScript-код. Парсит код в AST, компилирует в байт-код или машинный код (JIT), оптимизирует и выполняет. Основные движки: V8 (Chrome, Node.js), SpiderMonkey (Firefox), JavaScriptCore (Safari).

---

## Что такое JavaScript движок

**JavaScript движок** (JS Engine) — это программа или интерпретатор, который **читает и выполняет** JavaScript-код.

**Основные задачи:**
1. **Парсинг** — преобразование кода в структуру данных (AST)
2. **Компиляция** — преобразование в байт-код или машинный код
3. **Выполнение** — запуск скомпилированного кода
4. **Оптимизация** — ускорение повторно выполняемого кода
5. **Сборка мусора** — очистка памяти от неиспользуемых объектов

---

## Зачем нужен движок

**Браузеры и серверы не понимают JavaScript напрямую** — им нужен движок для:
- **Интерпретации** JavaScript-кода
- **Компиляции** в машинный код для быстрого выполнения
- **Оптимизации** производительности
- **Управления памятью** (сборка мусора)

Без движка JavaScript — просто текст.

---

## Основные JavaScript движки

| Движок | Где используется | Разработчик |
|--------|------------------|-------------|
| **V8** | Chrome, Edge, Node.js, Deno | Google |
| **SpiderMonkey** | Firefox | Mozilla |
| **JavaScriptCore (Nitro)** | Safari, WebKit | Apple |
| **Chakra** | Старый Edge (до 2020) | Microsoft |
| **Hermes** | React Native | Meta |

**Самый популярный:** V8 (Chrome, Node.js) — быстрый, мощный, с лучшими оптимизациями.

---

## Как работает JavaScript движок

### 1. Парсинг (Parsing)

**Что происходит:**
- Движок читает JavaScript-код (текст)
- Лексический анализ (**Tokenization**) — разбивает код на токены (ключевые слова, операторы, идентификаторы)
- Синтаксический анализ (**Parsing**) — строит **AST** (Abstract Syntax Tree — абстрактное синтаксическое дерево)

**AST** — древовидная структура кода, где каждый узел — это элемент программы (переменная, функция, выражение).

**Пример:**

```js
const sum = a + b;
```

**AST (упрощённо):**

```
VariableDeclaration
  - const
  - Identifier: sum
  - BinaryExpression
    - Identifier: a
    - Operator: +
    - Identifier: b
```

---

### 2. Компиляция (Compilation)

Раньше JavaScript был **интерпретируемым** (построчное выполнение), но современные движки используют **JIT-компиляцию** (Just-In-Time).

**JIT-компиляция:**
- Код **не компилируется заранее** (как в C++)
- Код **компилируется во время выполнения** (on-the-fly)
- Сначала генерируется **байт-код** (промежуточный код), затем — **машинный код**

**Этапы в V8:**

1. **Ignition (интерпретатор):**
   - Быстро генерирует байт-код из AST
   - Начинает выполнение сразу (без ожидания полной компиляции)

2. **TurboFan (оптимизирующий компилятор):**
   - Анализирует "горячие" функции (которые часто вызываются)
   - Компилирует их в **оптимизированный машинный код**
   - Использует информацию о типах для ускорения

**Преимущества JIT:**
- Быстрый старт (не нужно ждать полной компиляции)
- Оптимизация во время выполнения (учитываются реальные данные)

---

### 3. Выполнение (Execution)

**Call Stack (стек вызовов):**
- Движок выполняет код функция за функцией
- Каждый вызов функции добавляется в стек
- После выполнения — удаляется из стека

**Memory Heap (куча):**
- Здесь хранятся объекты, массивы, функции
- Динамическое выделение памяти

---

### 4. Оптимизация (Optimization)

**Движок отслеживает "горячий" код** (hot code) — функции, которые выполняются часто.

**Оптимизации:**
- **Inline Caching** — кэширование результатов доступа к свойствам объектов
- **Hidden Classes** — оптимизация доступа к свойствам через скрытые классы
- **Escape Analysis** — определение, нужно ли выделять объект в heap или можно на стеке
- **Dead Code Elimination** — удаление неиспользуемого кода

**Деоптимизация:**  
Если предположения движка оказались неверными (например, функция начала получать другие типы), код **деоптимизируется** обратно в байт-код.

---

### 5. Сборка мусора (Garbage Collection)

**Garbage Collector (GC)** автоматически удаляет объекты, которые больше не используются.

**Алгоритмы в V8:**
- **Mark-and-Sweep** — помечает достижимые объекты, удаляет недостижимые
- **Generational GC** — делит объекты на "молодые" (живут недолго) и "старые" (живут долго), собирает молодые чаще

**Когда запускается:**
- Периодически в фоне
- Когда память заканчивается

---

## Как движок ускоряет код

### 1. JIT-компиляция

Превращает JavaScript в машинный код → выполнение быстрее интерпретации.

### 2. Inline Caching

Кэширует пути доступа к свойствам объектов:

```js
function getX(obj) {
  return obj.x; // движок запоминает структуру obj
}
```

При повторных вызовах с похожими объектами — доступ моментальный.

### 3. Hidden Classes

V8 создаёт скрытые классы (как в C++) для объектов с одинаковой структурой:

```js
function Point(x, y) {
  this.x = x;
  this.y = y;
}
```

Все объекты `Point` получают одинаковый скрытый класс → быстрый доступ к свойствам.

**Важно:**  
Добавление свойств в разном порядке создаёт разные классы → медленнее:

```js
// ❌ Плохо — разные hidden classes
const p1 = {}; p1.x = 1; p1.y = 2;
const p2 = {}; p2.y = 2; p2.x = 1; // другой порядок

// ✅ Хорошо — одинаковые hidden classes
const p1 = { x: 1, y: 2 };
const p2 = { x: 3, y: 4 };
```

### 4. Оптимизация типов

Если функция всегда получает числа, движок оптимизирует под числа:

```js
function add(a, b) {
  return a + b;
}

add(1, 2); // движок: "a и b — числа"
add(3, 4); // оптимизация: используется быстрое сложение чисел
add("a", "b"); // деоптимизация: "а, это строки!"
```

**Совет:** не меняйте типы аргументов функций для лучшей производительности.

---

## Взаимодействие с окружением

**Движок сам по себе — только исполнитель JavaScript.**

Но ему нужны **API окружения** (Runtime Environment):

- **Браузер:** предоставляет Web APIs (DOM, fetch, setTimeout, localStorage)
- **Node.js:** предоставляет Node APIs (fs, http, path)

**Схема:**

```
JavaScript код
    ↓
JS движок (V8, SpiderMonkey)
    ↓
Runtime APIs (DOM, fetch, fs)
    ↓
Операционная система
```

---

## Event Loop и движок

**Движок** выполняет только **синхронный код** (Call Stack).

**Event Loop** (цикл событий) — это **часть окружения**, а не движка. Он:
- Управляет асинхронными операциями (setTimeout, Promise, I/O)
- Добавляет колбэки в Call Stack, когда тот пуст

**Вывод:**  
Движок + Event Loop (окружение) = полноценное выполнение JavaScript.

---

## Вопросы на собеседовании

| Вопрос | Краткий ответ |
|--------|----------------|
| Что такое JS движок? | Программа, которая парсит, компилирует и выполняет JavaScript-код |
| Зачем нужен движок? | Браузеры/серверы не понимают JS напрямую; движок превращает JS в машинный код |
| Какие бывают движки? | V8 (Chrome, Node.js), SpiderMonkey (Firefox), JavaScriptCore (Safari) |
| Что такое JIT-компиляция? | Компиляция кода во время выполнения (Just-In-Time) для ускорения |
| Как движок ускоряет код? | JIT-компиляция, inline caching, hidden classes, оптимизация типов |
| Что такое AST? | Abstract Syntax Tree — древовидная структура кода после парсинга |
| Что такое Call Stack? | Стек вызовов функций; движок выполняет код функция за функцией |
| Что такое сборка мусора? | Автоматическое удаление неиспользуемых объектов из памяти |
| Движок и Event Loop — одно и то же? | Нет. Движок выполняет синхронный код, Event Loop (окружение) управляет асинхронным |
| Что такое Hidden Classes? | Внутренние структуры V8 для ускорения доступа к свойствам объектов |

---

## Кратко для ответа

JavaScript движок — программа, которая выполняет JS-код: парсит код в AST (дерево), компилирует в байт-код или машинный код через JIT, выполняет, оптимизирует "горячие" функции и собирает мусор. Основные движки: V8 (Chrome, Node.js), SpiderMonkey (Firefox), JavaScriptCore (Safari). Движок ускоряет код через inline caching, hidden classes, оптимизацию типов. Движок выполняет синхронный код, а Event Loop (часть окружения) управляет асинхронным.
